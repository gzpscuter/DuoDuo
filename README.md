<h1 align='center'>duoduo</h1>

### 1. 介绍

参考muduo构建的基于epoll反应堆的高性能c++网络通信库，可以接收HTTP请求和发送HTTP响应，辅以**内存池处理用户层缓冲区读写**，可极大增强epoll反应堆的对发送数据大小的动态范围，并减少内存碎片产生。同时该网络库利用**单层时间轮**处理定时任务，在实现高并发定时的同时，也能将**定时器作为独立组件独立开来，即插即用，减少系统耦合**，这点区别于muduo将定时事件交由EventLoop线程处理，有多少EventLoop线程就有多少个定时器。该通信库就随便叫做朵朵好了。

### 2.依赖

* c++17
* 64bit Linux

### 3.组件

#### 3.1 buffer

* 基于jemalloc4内存池构建，具备线程安全特性，多线程下性能优于单线程，在多次内存分配和释放操作中，buffer具有显著比vector更优的性能。具体可见<a name="基于jemalloc4的内存池.md" href="./buffer/README.md#test">基于jemalloc4的内存池</a>
* 包含m_writeIndex和m_readerIndex，用于读写缓冲区。

#### 3.2 timer

* 高并发定时器，基于时间轮构造，可以实现10万+任务的秒级定时，支持us级别的任务定时操作。具体可见[timer](./timer/README.md)

#### 3.3 LongAddr和DoubleAddr

* LongAddr是高性能的long类型原子计数类，通过负载均衡技术将线程分配到最少线程数的cell，可实现多线程下高性能的long计数，测试中具有比atomic<long>高出一倍的性能。具体可见[LongAddr](./buffer/LongAddr/README.md)
* DoubleAddr是线程安全的double类型计数类，提供c++不支持的对浮点类型的原子计数功能，实现原理与LongAddr类似。具体可见[DoubleAddr](./buffer/LongAddr/README.md)

#### 3.4 http

* HTTP服务器，接收HTTP请求，发送HTTP响应。

### 4. 结果

利用wrk测试不同返回响应大小下duoduo与muduo的qps，测试环境是8虚拟核i7 6700HQ，测试指令如下，HTTP请求为**长连接**。

```
wrk -t12 -c400 -d10s http://127.0.0.1:7000
```

|        | 1024         | 4096         | 32768        | 40958        | 49150        | 57342        | 65536        | 81920        |
| ------ | ------------ | ------------ | ------------ | ------------ | ------------ | ------------ | ------------ | ------------ |
| duoduo | 29501.99     | 29602.93     | 28119.07     | **25973.82** | **25208.83** | **24761.09** | **23838.20** | **14270.47** |
| muduo  | **30179.33** | **30914.48** | **28423.18** | 25302.31     | 15813.48     | 15487.01     | 14298.54     | 12217.72     |

结果如上图表所示，最上面行是返回响应的大小，分别为1024B，4096B，32768B……。粗体为较高的一方，可以看出在返回响应大小40958时，duoduo的qps超过muduo；在49150时，muduo的qps显著下降，而duoduo基本稳定，可见duoduo对响应大小的动态范围更佳。



